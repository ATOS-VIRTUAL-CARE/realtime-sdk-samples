<!DOCTYPE html>
<html lang="en">

<head>
  <title>Settings</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="//unpkg.com/loglevel"></script>
  <script src="https://sdk.virtualcareservices.net/dist/umd/vcs-realtime-sdk.min.js"></script>
  <script src="../config.js"></script>
</head>

<body>
  <h2>Settings</h2>
  <h3>Description</h3>
  <p>This sample shows how to change Realtime SDK configuration.</p>
  <p>Open the <a href="./settings.html" target="_blank">same url</a> on another tab (or even another device/browser)
    and then join on both tabs.</p>
  <button id="joinLeaveBtn">Join</button>
  <button id="muteUnmuteBtn" class="hidden">Mute</button>

  <h2>Realtime SDK Configuration</h2>
  <div>
    <button id="toogleOnlyRelayStatus" onclick="toggleOnlyRelayCandidates()" title="Enable/disable use only relay candidates">Toggle Only Relay Candidates</button>
    :&nbsp;<span class="status" id="onlyRelayStatus">OFF</span>
  </div>
  <div>
    <button onclick="toggleAgc()" title="Enable/disable use only relay candidates">Toggle Automatic Gain Control</button>
    :&nbsp;<span class="status" id="agcStatus">ON</span>
  </div>

  <h2>Logs</h2>
  <div>
    <button id="toogleInlineLogs" onclick="toogleInlineLogs()" title="Enable/disable inline logs">Toggle Inline logs</button>
    :&nbsp;<span class="status" id="inlineLogsStatus">OFF</span>
  </div>

  <div id="videos"></div>
  <div id="logs"></div>

  <script>
    // Define custom logger for inline logging
    const inlineLogger = {
      debug(...args) { printLog('DEBUG', ...args) },
      info(...args) { printLog('INFO', ...args) },
      warn(...args) { printLog('WARN', ...args) },
      error(...args) { printLog('ERROR', ...args) }
    }

    let room = null;
    let logger = null;

    // Custom log function for inline logging
    function printLog(type, ...args) {
      if (log.getLevel() <= log.levels[type]) {
        args.unshift(moment().format('HH:mm:ss.SSS'));
        const pre = document.createElement('pre');
        pre.classList.add(type);
        pre.innerText = args.reduce((prevVal, currVal, idx) => {
          const s = typeof currVal === 'string' ? currVal : JSON.stringify(currVal, null, 2);
          return idx === 0 ? s : prevVal + ' ' + s;
        }, '');
        document.getElementById('logs').appendChild(pre);
      }
    }

    function render(participant) {
      const div = document.createElement('div');
      div.id = participant.address;
      // Let SDK create the video element, and update changes to the media stream
      participant.attach(div);
      videos.appendChild(div);
    }

    function remove(participant) {
      // Remove the video wrapper div
      document.getElementById(participant.address)?.remove();
    }

    function cleanup() {
      videos.innerHTML = '';
    }

    function leaveRoom() {
      room?.leave();
      room = null;
      joinLeaveBtn.innerText = 'Join';
      muteUnmuteBtn.classList.add('hidden');
      joinLeaveBtn.disabled = false;
    }

    function setElementStatus(elementId, value) {
      document.getElementById(elementId).textContent = value ? 'ON' : 'OFF';
    }

    function toggleOnlyRelayCandidates() {
      RealtimeSdk.Settings.onlyRelayCandidates = !RealtimeSdk.Settings.onlyRelayCandidates;
      setElementStatus('onlyRelayStatus', RealtimeSdk.Settings.onlyRelayCandidates);
      console.log('RealtimeSdk.Settings.onlyRelayCandidates: ', RealtimeSdk.Settings.onlyRelayCandidates);
    }

    function toggleAgc() {
      RealtimeSdk.Settings.autoGainControl = !RealtimeSdk.Settings.autoGainControl;
      setElementStatus('agcStatus', RealtimeSdk.Settings.autoGainControl);
    }

    function toogleInlineLogs() {
      logger = logger ? null : inlineLogger
      setElementStatus('inlineLogsStatus', logger === inlineLogger);
      RealtimeSdk.setLogger(logger);
      console.log('toogleInlineLogs: ', logger === inlineLogger);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Import VCS_DOMAIN and ROOM_TOKEN from config.js.
      // Edit config.js with your own vcs-domain and token.
      await window.vcs(document);

      const joinLeaveBtn = document.getElementById('joinLeaveBtn');
      const muteUnmuteBtn = document.getElementById('muteUnmuteBtn');
      const videos = document.getElementById('videos');

      console.log('RealtimeSdk.Settings.onlyRelayCandidates: ', RealtimeSdk.Settings.onlyRelayCandidates);
      setElementStatus('onlyRelayStatus', RealtimeSdk.Settings.onlyRelayCandidates);
      setElementStatus('agcStatus', RealtimeSdk.Settings.autoGainControl);
      setElementStatus('inlineLogsStatus', logger === inlineLogger);


      joinLeaveBtn.addEventListener('click', async () => {
        if (room) {
          leaveRoom();
        } else {
          try {
            // logger.info('[myapp]: Joining room...');
            joinLeaveBtn.disabled = true;
            room = await RealtimeSdk.joinRoom(ROOM_TOKEN, {
              host: VCS_DOMAIN
            });
            // logger.info(`[myapp]: Joined room: ${room.name}`);

            joinLeaveBtn.disabled = false;
            joinLeaveBtn.innerText = 'Leave';
            muteUnmuteBtn.classList.remove('hidden');
            render(room.localParticipant);
            room.remoteParticipants.forEach(render);
            room.on('participantJoined', render);
            room.on('participantLeft', remove);
            room.on('roomLeft', cleanup);
          } catch (err) {
            // logger.error('[myapp]: Error joining room.', err);
            leaveRoom();
          }
        }
      });

      muteUnmuteBtn.addEventListener('click', () => {
        room.toggleMute();
        muteUnmuteBtn.innerText = room.isMuted() ? 'Unmute' : 'Mute';
      });
    });
  </script>
</body>

</html>